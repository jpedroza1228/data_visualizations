---
title: "R Functions"
author: "JP"
date: "12/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Things to Be Able To Mentor On

1. Installing Packages
2. Loading Data
3. GGplot2
4. Visualizing Data
5. Mutate
6. Joins
7. Summarizing
8. Filter
9. Tidy Data
10. Purrr
11. Functions
12. Cut
13. if_else
14. case_when
15. Models & ANOVA
16. GT Tables
17. R Markdown Reports
18. Publishing on RStudio Connect

---------------------------------------------------------------

1. Installing packages

```{r, echo = TRUE, eval = FALSE}
install.packages("tidyverse")
install.packages(c("dplyr", "tidyr", "ggplot2"))
install.packages(c("rio", "here"))
```

```{r, eval = TRUE, echo = TRUE}
library(tidyverse)
library(tidymodels)

theme_set(theme_light())
```

2. Loading data

This works best when working in projects.

There are different ways of loading data based on what type of data you are importing.

- Excel/XML

```{r, echo = TRUE, eval = FALSE}
data <- readxl::read_xlsx(here::here("take_home_to_be_completed", "data/data_supplemental.xlsx"))
```

- CSV

```{r, echo = TRUE, eval = FALSE}
data <- read_csv("cpp_data/psy_soc11_f.csv")
# data <- here::here("data", "file.csv")
```

- SPSS/SAV

```{r, echo = TRUE, eval = FALSE}
data <- rio::import(here::here("data", "file.sav"))
```

- SAS/XPT

```{r, echo = TRUE, eval = FALSE}
haven::read_xpt(here::here("take_home_to_be_completed", "data/baseline_data.xpt"))
```

---------------------------------------------------------------

11. Functions

```{r, eval = TRUE, echo = TRUE}
year_function <- function(name, year){
  link <- glue::glue("cpp_data/gpa_equity_gap/{name}{year}.csv")
  read_csv(link)
}
```

---------------------------------------------------------------

10. Purrr

```{r, echo = TRUE, eval = FALSE}
psy_soc <- fs::dir_ls(here::here("cpp_data"),
                           glob = "*.csv")

psy_soc_combined <-map_dfr(psy_soc, read_csv)
```

```{r, echo = TRUE, eval = TRUE}
psy_soc <- fs::dir_ls(here::here("cpp_data"),
                           glob = "*.csv")

psysoc <-map_dfr(psy_soc, read_csv) %>% 
  janitor::clean_names()
head(psysoc)

first_gen <- map_df(11:20, ~year_function(name = "firstgen", year = .x)) %>% 
  janitor::clean_names()
head(first_gen)

race_enroll <- map_df(11:20, ~year_function(name = "eth_enroll", year = .x)) %>% 
  janitor::clean_names()
head(race_enroll)

race_gpa <- map_df(11:20, ~year_function(name = "eth_gpa", year = .x)) %>% 
  janitor::clean_names()
head(race_gpa)

gender <- map_df(11:20, ~year_function(name = "gender", year = .x)) %>% 
  janitor::clean_names()
head(gender)

```

---------------------------------------------------------------

5. Mutate

```{r}
psysoc <- psysoc %>% 
  separate(col = "year_term", into = c("year", "term"), sep = " - ") %>% 
  separate(col = "course_code", into = c("department", "course_number"), sep = 3) %>% 
  mutate(non_passing_rate = str_remove_all(non_passing_rate, "%"),
         non_passing_rate = as.numeric(non_passing_rate),
         non_passing_rate = non_passing_rate/100)

first_gen <- first_gen %>% 
  separate(col = "course_code", into = c("department", "course_number"), sep = 3) %>% 
  rename(course_title = course)

race_enroll <- race_enroll %>% 
  separate(col = "course_code", into = c("department", "course_number"), sep = 3) %>% 
  mutate(white_enroll = recode(white, "N<10" = "10"),
         black_enroll = recode(african_american, "N<10" = "10"),
         asian_enroll = recode(asian, "N<10" = "10")) %>%
  dplyr::select(-"data_download_for_which_courses_have_the_largest_gpa_equity_gaps", -"white", -"african_american", -"asian") %>% 
  rename(latino_enroll = latino_a,
         course_title = course)

race_gpa <- race_gpa %>% 
  separate(col = "course_code", into = c("department", "course_number"), sep = 3) %>%
  mutate(white_gpa = recode(white, "N<10" = NA_character_),
         black_gpa = recode(african_american, "N<10" = NA_character_),
         asian_gpa = recode(asian, "N<10" = NA_character_)) %>% 
  dplyr::select(-"white", -"african_american", -"asian") %>% 
  rename(latino_gpa = latino_a,
         course_title = course)

gender <- gender %>% 
  separate(col = "course_code", into = c("department", "course_number"), sep = 3) %>%
  mutate(male_enroll = recode(male_enrollment, "N<10" = NA_character_),
         male_gpa = recode(male_gpa, "N<10" = NA_character_),
         gpa_gap = recode(gpa_gap, "N/A" = NA_character_)) %>% 
  dplyr::select(-"male_enrollment") %>% 
  rename(course_title = course,
         female_enroll = female_enrollment)
```

```{r}
names(psysoc)
names(first_gen)
names(gender)
names(race_enroll)
names(race_gpa)

str(psysoc)
str(first_gen)
str(gender)
str(race_enroll)
str(race_gpa)
```

```{r}
psysoc <- psysoc %>% 
  mutate(year = factor(year),
         term = factor(term),
         department = factor(department),
         course_number = factor(course_number))

first_gen <- first_gen %>% 
  dplyr::select(-x1) %>% 
  mutate(department = factor(department),
         course_number = factor(course_number),
         year = factor(year)) %>% 
  rename(gen_gpa_gap = gpa_gap)

gender <- gender %>% 
  dplyr::select(-x1) %>% 
  mutate(department = factor(department),
         course_number = factor(course_number),
         male_gpa = as.numeric(male_gpa),
         gpa_gap = as.numeric(gpa_gap),
         year = factor(year),
         male_enroll = as.numeric(male_enroll)) %>% 
  rename(gender_gpa_gap = gpa_gap)

race_enroll <- race_enroll %>% 
  dplyr::select(-x1) %>% 
  mutate(department = factor(department),
         course_number = factor(course_number),
         year = factor(year),
         white_enroll = as.numeric(white_enroll),
         black_enroll = as.numeric(black_enroll),
         asian_enroll = as.numeric(asian_enroll))

race_gpa <- race_gpa %>% 
  dplyr::select(-x1) %>% 
  mutate(department = factor(department),
         course_number = factor(course_number),
         year = factor(year),
         white_gpa = as.numeric(white_gpa),
         black_gpa = as.numeric(black_gpa),
         asian_gpa = as.numeric(asian_gpa))
```


---------------------------------------------------------------

6. Joins

```{r}
data <- left_join(psysoc, first_gen, by = c("year", "department", "course_number", "course_title")) %>% 
  left_join(gender, by = c("year", "department", "course_number", "course_title")) %>% 
  left_join(race_enroll, by = c("year", "department", "course_number", "course_title")) %>%
  left_join(race_gpa, by = c("year", "department", "course_number", "course_title")) %>% 
  rename(first_gen_enroll = first_gen_enrollment,
         non_first_gen_enroll = not_first_gen_enrollment)

data <- data %>% 
  mutate(year2 = as.numeric(year),
         term_type = case_when(year2 >= 9 ~ "Semester",
                               year2 < 9 ~ "Quarter"))
```

---------------------------------------------------------------

3. ggplot2

```{r}
names(data)

data %>% 
  pivot_longer(cols = c(first_gen_enroll, non_first_gen_enroll,
                        female_enroll, male_enroll,
                        latino_enroll, white_enroll, black_enroll, asian_enroll),
               names_to = "enroll_types",
               values_to = "enroll_numbers") %>% 
  filter(department == "PSY" |
           department == "SOC") %>% 
  filter(term == "Academic Year") %>% 
  mutate(year_short = recode(year, "2011" = "11",
                             "2012" = "12", 
                             "2013" = "13",
                             "2014" = "14",
                             "2015" = "15",
                             "2016" = "16",
                             "2017" = "17",
                             "2018" = "18",
                             "2019" = "19",
                             "2020" = "20",
                             "2021" = "21")) %>%
  drop_na(enroll_numbers) %>% 
  ggplot(aes(course_number, enroll_numbers)) + 
  geom_text(aes(color = year_short, label = year_short), 
            size = 4) +
  facet_wrap(~term_type, scales = "free") +
  coord_flip() +
  theme(legend.position = "none")

data %>% 
  filter(department == "PSY" |
           department == "SOC" &
           term == "Academic Year") %>% 
  filter(year == 2011 | year == 2020) %>%
  ggplot(aes(course_number, non_passing_rate)) + 
  geom_point(aes(color = department), size = 3) +
  facet_wrap(~term_type, scales = "free") +
  coord_flip()
```

---------------------------------------------------------------

4. Visualizing Data

```{r}
non_pass_rate_plot <- data %>% 
  filter(course_number == 2201 |
           course_number == 2204 |
           course_number == 2210 |
           course_number == 2222 |
           course_number == 3307 |
           course_number == 4433 |
           course_number == 4611 |
           course_number == 201 |
           course_number == 204 |
           course_number == 210 |
           course_number == 307 |
           course_number == 433 |
           course_number == 498) %>% 
  mutate(course_number = recode(course_number, "2201" = "Introduction-S",
                                "2204" = "Research Methods-S",
                                "2210" = "Mind, Brain, Behavior-S",
                                "2222" = "Careers-S",
                                "3307" = "Statistics-S",
                                "4433" = "Experimental-S",
                                "4611" = "Senior Symposium-S",
                                "201" = "Introduction-Q",
                                "204" = "Research Methods-Q",
                                "210" = "Mind, Brain, Behavior-Q",
                                "307" = "Statistics-Q",
                                "433" = "Experimental-Q",
                                "498" = "Senior Symposium-Q"),
         year_short = recode(year, "2011" = "11",
                             "2012" = "12", 
                             "2013" = "13",
                             "2014" = "14",
                             "2015" = "15",
                             "2016" = "16",
                             "2017" = "17",
                             "2018" = "18",
                             "2019" = "19",
                             "2020" = "20",
                             "2021" = "21")) %>% 
  filter(department == "PSY") %>% 
  filter(term == "Academic Year") %>% 
  ggplot(aes(fct_reorder(course_number, non_passing_rate), non_passing_rate)) + 
  geom_text(aes(color = year_short, label = year_short), 
            size = 4,
            position = position_jitter(width = .3, seed = 405)) +
  coord_flip() +
  scale_color_manual(values = c("blue", "#884EA0", "#2471A3", "#17A589", "#D4AC0D", "#229954",
                                "#BAF10F", "#2E4053", "#CB4335", "#0FB7F1")) +
  labs(x = "",
       y = "Non-Passing Rate",
       title = "Non-passing rate for core Psychology classes",
       subtitle = "Comparisons between Quarter and Semester",
       caption = "Data gathered from Tableau resources from Cal Poly Pomona") +
  theme(legend.position = "none")

non_pass_rate_plot
```

---------------------------------------------------------------

7. Summarizing

```{r}

```

---------------------------------------------------------------

8. Filter

```{r}

```

---------------------------------------------------------------

9. Tidy Data

```{r}

```

---------------------------------------------------------------

12. Cut

```{r}

```


---------------------------------------------------------------

13. if_else

```{r}

```

---------------------------------------------------------------

14. case_when

```{r}

```

---------------------------------------------------------------

15. Models & ANOVA

```{r}

set.seed(12222021)

gen_split <- initial_split(data, prop = .8, strata = department)

gen_train <- training(gen_split)
gen_test <- testing(gen_split)

set.seed(12222021)

gen_boot <- vfold_cv(gen_train, strata = "department", v = 10)
head(gen_boot)

set.seed(12222021)

gen_recipe <- recipe(non_passing_rate ~ .,
                     data = gen_train) %>% 
  step_zv(all_predictors(), -all_outcomes())

set.seed(12222021)

model <- linear_reg() %>% 
  set_engine("lm") %>% 
  set_mode("regression") %>% 
  set_args(penalty = 0,
           mixture = 0)

flow <- workflow() %>% 
  add_recipe(gen_recipe) %>% 
  add_model(model) 

set.seed(12222021)

gen_fit <- fit_resamples(object = flow,
                         resamples = gen_boot,
                         control = control_resamples(verbose = TRUE,
                                                     save_pred = TRUE))

collect_metrics(gen_fit)
                         
```

---------------------------------------------------------------

16. GT Tables

```{r}

```

---------------------------------------------------------------

17. R Markdown Reports

```{r}

```

---------------------------------------------------------------

18. Publishing on RStudio Connect

```{r}

```

